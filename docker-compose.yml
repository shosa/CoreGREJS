services:
  backend:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    container_name: coregrejs-backend
    restart: unless-stopped

    ports:
      - "3011:3011"  # Backend API

    volumes:
      # Persist storage directories on host
      - ./volumes/backend/storage/export:/app/storage/export
      - ./volumes/backend/storage/jobs:/app/storage/jobs
      - ./volumes/backend/storage/uploads:/app/storage/uploads
      - ./volumes/backend/storage/logs:/app/storage/logs

    environment:
      # Application
      NODE_ENV: ${NODE_ENV:-production}
      APP_NAME: ${APP_NAME:-CoreGREJS}
      APP_VERSION: ${APP_VERSION:-1.0.0}
      PORT: 3011

      # Database - Connessione a MySQL core-services
      DATABASE_URL: mysql://${DB_USER:-root}:${DB_PASS:-rootpassword}@${DB_HOST:-core-mysql}:${DB_PORT:-3306}/${DB_NAME:-coregrejs}

      # Redis - Connessione a Redis condiviso in CoreServices
      REDIS_HOST: ${REDIS_HOST:-core-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-coresuite_redis}

      # JWT Secret
      JWT_SECRET: ${JWT_SECRET:-coregre_jwt_secret_change_in_production}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-24h}

      # Frontend URL (per CORS)
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3010}

      # Timezone
      TZ: Europe/Rome

    networks:
      - core-network  # Network condivisa con tutti i servizi Core

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3011/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s

    labels:
      - "com.coresuite.app=coregrejs-backend"
      - "io.portainer.accesscontrol.public"
      - "com.coresuite.environment=${NODE_ENV:-production}"

  frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3011}
    container_name: coregrejs-frontend
    restart: unless-stopped

    ports:
      - "3010:3000"  # Frontend Web UI

    environment:
      # Application
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3000

      # Backend API URL
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3011}

      # Timezone
      TZ: Europe/Rome

    depends_on:
      - backend

    networks:
      - core-network  # Network condivisa con tutti i servizi Core

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3010"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s

    labels:
      - "com.coresuite.app=coregrejs-frontend"
      - "io.portainer.accesscontrol.public"
      - "com.coresuite.environment=${NODE_ENV:-production}"

networks:
  # Usa la network condivisa CoreSuite
  core-network:
    external: true
    name: core-network
