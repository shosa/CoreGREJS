generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== AUTH ====================

model User {
  id            Int       @id @default(autoincrement())
  userName      String    @unique @map("user_name") @db.VarChar(50)
  nome          String    @db.VarChar(100)
  password      String    @db.VarChar(255)
  mail          String?   @db.VarChar(100)
  adminType     String    @default("operator") @map("admin_type") @db.VarChar(20)
  themeColor    String    @default("blue") @map("theme_color") @db.VarChar(20)
  lastLogin     DateTime? @map("last_login")
  expires       DateTime?
  rememberToken String?   @map("remember_token") @db.VarChar(255)
  seriesId      String?   @map("series_id") @db.VarChar(255)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  permissions   Permission?
  notifications Notification[]
  activityLogs  ActivityLog[]
  userWidgets   UserWidget[]
  jobs          Job[]

  // Production records created/updated by this user
  productionRecordsCreated ProductionRecord[] @relation("ProductionCreator")
  productionRecordsUpdated ProductionRecord[] @relation("ProductionUpdater")

  // Repairs
  riparazioni        Riparazione[]
  riparazioniInterne RiparazioneInterna[]

  @@map("auth_users")
}

model Permission {
  id       Int  @id @default(autoincrement())
  userId   Int  @unique @map("id_utente")
  permessi Json

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("auth_permissions")
}

// ==================== CORE ====================

model ActivityLog {
  id          Int      @id @default(autoincrement())
  userId      Int?     @map("user_id")
  action      String   @db.VarChar(100)
  description String?  @db.Text
  ipAddress   String?  @map("ip_address") @db.VarChar(45)
  userAgent   String?  @map("user_agent") @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("core_log")
}

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(100)
  value     String?  @db.Text
  type      String   @default("string") @db.VarChar(20)
  group     String   @default("general") @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("core_settings")
}

// Tabella principale dati produzione - struttura LEGACY
model CoreData {
  id                   Int     @id @default(autoincrement())
  st                   String? @map("St") @db.VarChar(3)
  ordine               Int?    @map("Ordine")
  rg                   Int?    @map("Rg")
  cCli                 Int?    @map("CCli")
  ragioneSociale       String? @map("Ragione Sociale") @db.VarChar(35)
  cartel               Int?    @unique @map("Cartel")
  commessaCli          String? @map("Commessa Cli") @db.VarChar(20)
  po                   String? @map("PO") @db.VarChar(255)
  articolo             String  @map("Articolo") @db.VarChar(255)
  descrizioneArticolo  String  @map("Descrizione Articolo") @db.VarChar(255)
  nu                   String? @map("Nu") @db.VarChar(2)
  marcaEtich           String? @map("Marca Etich") @db.VarChar(13)
  ln                   String? @map("Ln") @db.VarChar(2)
  p01                  Int?    @map("P01")
  p02                  Int?    @map("P02")
  p03                  Int?    @map("P03")
  p04                  Int?    @map("P04")
  p05                  Int?    @map("P05")
  p06                  Int?    @map("P06")
  p07                  Int?    @map("P07")
  p08                  Int?    @map("P08")
  p09                  Int?    @map("P09")
  p10                  Int?    @map("P10")
  p11                  Int?    @map("P11")
  p12                  Int?    @map("P12")
  p13                  Int?    @map("P13")
  p14                  Int?    @map("P14")
  p15                  Int?    @map("P15")
  p16                  Int?    @map("P16")
  p17                  Int?    @map("P17")
  p18                  Int?    @map("P18")
  p19                  Int?    @map("P19")
  p20                  Int?    @map("P20")
  tot                  Int?    @map("Tot")

  @@index([ordine])
  @@index([commessaCli])
  @@index([articolo])
  @@map("core_dati")
}

model CoreAnagrafica {
  id        Int      @id @default(autoincrement())
  codice    String?  @db.VarChar(50)
  nome      String?  @db.VarChar(200)
  tipo      String?  @db.VarChar(50)
  indirizzo String?  @db.VarChar(255)
  telefono  String?  @db.VarChar(50)
  email     String?  @db.VarChar(100)
  piva      String?  @db.VarChar(20)
  cf        String?  @db.VarChar(20)
  note      String?  @db.Text
  attivo    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("core_anag")
}

// ==================== RIPARAZIONI ====================

model Riparazione {
  id            Int       @id @default(autoincrement())
  idRiparazione String    @unique @map("id_riparazione") @db.VarChar(10)

  // Riferimenti
  cartellino    String?   @db.VarChar(50)
  userId        Int?      @map("user_id")
  numerataId    Int?      @map("numerata_id")

  // 20 colonne taglie (quantità per ogni taglia)
  p01           Int       @default(0)
  p02           Int       @default(0)
  p03           Int       @default(0)
  p04           Int       @default(0)
  p05           Int       @default(0)
  p06           Int       @default(0)
  p07           Int       @default(0)
  p08           Int       @default(0)
  p09           Int       @default(0)
  p10           Int       @default(0)
  p11           Int       @default(0)
  p12           Int       @default(0)
  p13           Int       @default(0)
  p14           Int       @default(0)
  p15           Int       @default(0)
  p16           Int       @default(0)
  p17           Int       @default(0)
  p18           Int       @default(0)
  p19           Int       @default(0)
  p20           Int       @default(0)

  qtaTotale     Int       @default(0) @map("qta_totale")

  // Info riparazione
  causale       String?   @db.Text
  laboratorioId Int?      @map("laboratorio_id")  // Destinazione
  repartoId     Int?      @map("reparto_id")      // Provenienza
  lineaId       Int?      @map("linea_id")

  // Stato e date
  data          DateTime  @default(now())
  completa      Boolean   @default(false)
  dataChiusura  DateTime? @map("data_chiusura")

  // Note aggiuntive
  note          String?   @db.Text

  // Timestamp
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relazioni
  user        User?        @relation(fields: [userId], references: [id])
  numerata    Numerata?    @relation(fields: [numerataId], references: [id])
  laboratorio Laboratorio? @relation(fields: [laboratorioId], references: [id])
  reparto     Reparto?     @relation(fields: [repartoId], references: [id])
  linea       Linea?       @relation(fields: [lineaId], references: [id])

  @@map("rip_riparazioni")
}

model RiparazioneInterna {
  id            Int       @id @default(autoincrement())
  idRiparazione String    @unique @map("id_riparazione") @db.VarChar(10)

  // Riferimenti
  cartellino    String?   @db.VarChar(50)
  userId        Int?      @map("user_id")
  numerataId    Int?      @map("numerata_id")

  // 20 colonne taglie (quantità per ogni taglia)
  p01           Int       @default(0)
  p02           Int       @default(0)
  p03           Int       @default(0)
  p04           Int       @default(0)
  p05           Int       @default(0)
  p06           Int       @default(0)
  p07           Int       @default(0)
  p08           Int       @default(0)
  p09           Int       @default(0)
  p10           Int       @default(0)
  p11           Int       @default(0)
  p12           Int       @default(0)
  p13           Int       @default(0)
  p14           Int       @default(0)
  p15           Int       @default(0)
  p16           Int       @default(0)
  p17           Int       @default(0)
  p18           Int       @default(0)
  p19           Int       @default(0)
  p20           Int       @default(0)

  qtaTotale     Int       @default(0) @map("qta_totale")

  // Info riparazione interna
  causale          String? @db.Text
  causaDifetto     String? @map("causa_difetto") @db.Text
  repartoOrigine   String? @map("reparto_origine") @db.VarChar(100)
  repartoDestino   String? @map("reparto_destino") @db.VarChar(100)

  // Stato e date
  data             DateTime  @default(now())
  completa         Boolean   @default(false)
  dataChiusura     DateTime? @map("data_chiusura")

  // Operatori
  operatoreApertura String? @map("operatore_apertura") @db.VarChar(100)
  operatoreChiusura String? @map("operatore_chiusura") @db.VarChar(100)

  // Note e allegati
  note          String?   @db.Text
  foto          String?   @db.VarChar(255)

  // Timestamp
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relazioni
  user     User?     @relation(fields: [userId], references: [id])
  numerata Numerata? @relation(fields: [numerataId], references: [id])

  @@map("rip_interne")
}

model Reparto {
  id          Int      @id @default(autoincrement())
  nome        String   @db.VarChar(100)
  codice      String?  @db.VarChar(20)
  descrizione String?  @db.Text
  attivo      Boolean  @default(true)
  ordine      Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  riparazioni Riparazione[]

  @@map("rip_reparti")
}

model Linea {
  id          Int      @id @default(autoincrement())
  nome        String   @db.VarChar(100)
  codice      String?  @db.VarChar(20)
  descrizione String?  @db.Text
  attivo      Boolean  @default(true)
  ordine      Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  riparazioni Riparazione[]

  @@map("rip_linee")
}

model Laboratorio {
  id        Int      @id @default(autoincrement())
  nome      String   @db.VarChar(100)
  codice    String?  @db.VarChar(20)
  indirizzo String?  @db.VarChar(255)
  telefono  String?  @db.VarChar(50)
  email     String?  @db.VarChar(100)
  attivo    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  riparazioni Riparazione[]

  @@map("rip_laboratori")
}

model Numerata {
  id  Int @id @default(autoincrement())

  // 20 colonne per i nomi delle taglie
  n01 String? @db.VarChar(10)
  n02 String? @db.VarChar(10)
  n03 String? @db.VarChar(10)
  n04 String? @db.VarChar(10)
  n05 String? @db.VarChar(10)
  n06 String? @db.VarChar(10)
  n07 String? @db.VarChar(10)
  n08 String? @db.VarChar(10)
  n09 String? @db.VarChar(10)
  n10 String? @db.VarChar(10)
  n11 String? @db.VarChar(10)
  n12 String? @db.VarChar(10)
  n13 String? @db.VarChar(10)
  n14 String? @db.VarChar(10)
  n15 String? @db.VarChar(10)
  n16 String? @db.VarChar(10)
  n17 String? @db.VarChar(10)
  n18 String? @db.VarChar(10)
  n19 String? @db.VarChar(10)
  n20 String? @db.VarChar(10)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  riparazioni        Riparazione[]
  riparazioniInterne RiparazioneInterna[]

  @@map("rip_idnumerate")
}

// ==================== QUALITY CONTROL ====================

model QualityRecord {
  id            Int      @id @default(autoincrement())
  cartellino    String   @db.VarChar(50)
  commessa      String?  @db.VarChar(100)
  modello       String?  @db.VarChar(100)
  colore        String?  @db.VarChar(100)
  taglia        String?  @db.VarChar(20)
  quantita      Int      @default(1)
  esito         String   @db.VarChar(20) // ok, ko, rework
  departmentId  Int?     @map("department_id")
  operatorId    Int?     @map("operator_id")
  defectTypeId  Int?     @map("defect_type_id")
  note          String?  @db.Text
  foto          String?  @db.VarChar(255)
  dataControllo DateTime @default(now()) @map("data_controllo")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  department QualityDepartment? @relation(fields: [departmentId], references: [id])
  operator   QualityOperator?   @relation(fields: [operatorId], references: [id])
  defectType QualityDefectType? @relation(fields: [defectTypeId], references: [id])

  @@map("cq_records")
}

model QualityDepartment {
  id          Int      @id @default(autoincrement())
  nome        String   @db.VarChar(100)
  codice      String?  @db.VarChar(20)
  descrizione String?  @db.Text
  attivo      Boolean  @default(true)
  ordine      Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  records QualityRecord[]

  @@map("cq_departments")
}

model QualityOperator {
  id        Int      @id @default(autoincrement())
  nome      String   @db.VarChar(100)
  cognome   String?  @db.VarChar(100)
  matricola String?  @unique @db.VarChar(50)
  pin       String?  @db.VarChar(10)
  attivo    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  records QualityRecord[]

  @@map("cq_operators")
}

model QualityDefectType {
  id          Int      @id @default(autoincrement())
  nome        String   @db.VarChar(100)
  codice      String?  @db.VarChar(20)
  categoria   String?  @db.VarChar(50)
  gravita     Int      @default(1) // 1-5
  descrizione String?  @db.Text
  attivo      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  records QualityRecord[]

  @@map("cq_deftypes")
}

model QualityException {
  id          Int       @id @default(autoincrement())
  commessa    String?   @db.VarChar(100)
  modello     String?   @db.VarChar(100)
  tipo        String    @db.VarChar(50)
  descrizione String?   @db.Text
  attivo      Boolean   @default(true)
  dataInizio  DateTime? @map("data_inizio")
  dataFine    DateTime? @map("data_fine")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("cq_exceptions")
}

// ==================== EXPORT / DDT ====================

// ==================== EXPORT/DDT (Modernizzato) ====================

// Tabella master articoli (normalizzata, no duplicati)
model ExportArticleMaster {
  id              Int      @id @default(autoincrement())
  codiceArticolo  String   @unique @map("codice_articolo") @db.VarChar(255)
  descrizione     String?  @db.VarChar(255)
  voceDoganale    String?  @map("voce_doganale") @db.VarChar(50)
  um              String?  @db.VarChar(10)
  prezzoUnitario  Decimal? @map("prezzo_unitario") @db.Decimal(10, 3)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  righe    ExportDocumentItem[]
  mancanti ExportMissingData[]

  @@index([codiceArticolo])
  @@map("exp_articoli_master")
}

// Terzisti (fornitori/subfornitori)
model ExportTerzista {
  id              Int      @id @default(autoincrement())
  ragioneSociale  String   @map("ragione_sociale") @db.VarChar(255)
  indirizzo1      String?  @map("indirizzo_1") @db.VarChar(255)
  indirizzo2      String?  @map("indirizzo_2") @db.VarChar(255)
  indirizzo3      String?  @map("indirizzo_3") @db.VarChar(255)
  nazione         String?  @db.VarChar(100)
  consegna        String?  @db.Text
  autorizzazione  String?  @db.VarChar(255)
  attivo          Boolean  @default(true)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  documenti ExportDocument[]

  @@index([ragioneSociale])
  @@map("exp_terzisti")
}

// Documenti DDT
model ExportDocument {
  id              Int       @id @default(autoincrement())
  progressivo     String    @unique @db.VarChar(50)
  terzistaId      Int       @map("terzista_id")
  data            DateTime  @db.Date
  stato           String    @default("Aperto") @db.VarChar(20) // Aperto, Chiuso
  firstBoot       Boolean   @default(true) @map("first_boot")
  autorizzazione  String?   @db.VarChar(255)
  commento        String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  terzista ExportTerzista           @relation(fields: [terzistaId], references: [id], onDelete: Restrict)
  righe    ExportDocumentItem[]
  piede    ExportDocumentFooter?
  mancanti ExportMissingData[]
  lanci    ExportLaunchData[]

  @@index([terzistaId])
  @@index([stato])
  @@index([createdAt])
  @@index([stato, createdAt])
  @@map("exp_documenti")
}

// Righe documento (referenziano articoli master)
model ExportDocumentItem {
  id              Int      @id @default(autoincrement())
  documentoId     Int      @map("documento_id")
  articleId       Int?     @map("article_id") // FK a master, NULL se riga libera
  qtaOriginale    Decimal? @default(0) @map("qta_originale") @db.Decimal(10, 2)
  qtaReale        Decimal? @default(0) @map("qta_reale") @db.Decimal(10, 2)
  isMancante      Boolean  @default(false) @map("is_mancante")
  rifMancante     String?  @map("rif_mancante") @db.VarChar(50)
  tipoRiga        String   @default("articolo") @map("tipo_riga") @db.VarChar(20) // articolo, libera
  // Campi per righe libere (senza FK article)
  codiceLibero    String?  @map("codice_libero") @db.VarChar(255)
  descrizioneLibera String? @map("descrizione_libera") @db.VarChar(255)
  voceLibera      String?  @map("voce_libera") @db.VarChar(50)
  umLibera        String?  @map("um_libera") @db.VarChar(10)
  prezzoLibero    Decimal? @map("prezzo_libero") @db.Decimal(10, 3)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  documento ExportDocument        @relation(fields: [documentoId], references: [id], onDelete: Cascade)
  article   ExportArticleMaster?  @relation(fields: [articleId], references: [id], onDelete: SetNull)

  @@index([documentoId])
  @@index([articleId])
  @@map("exp_righe_documento")
}

// Piede documento (footer) - con JSON array per voci doganali
model ExportDocumentFooter {
  id             Int      @id @default(autoincrement())
  documentoId    Int      @unique @map("documento_id")
  aspettoColli   String?  @map("aspetto_colli") @db.VarChar(255)
  nColli         Int?     @map("n_colli")
  totPesoLordo   Decimal? @map("tot_peso_lordo") @db.Decimal(10, 2)
  totPesoNetto   Decimal? @map("tot_peso_netto") @db.Decimal(10, 2)
  trasportatore  String?  @db.VarChar(255)
  consegnatoPer  String?  @map("consegnato_per") @db.Text
  // Array JSON: [{ voce: "56031480", peso: 123.45 }, ...]
  vociDoganali   Json?    @map("voci_doganali")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  documento ExportDocument @relation(fields: [documentoId], references: [id], onDelete: Cascade)

  @@map("exp_piede_documenti")
}

// Dati mancanti da altri DDT (per tracciare merce non ancora spedita)
model ExportMissingData {
  id          Int      @id @default(autoincrement())
  documentoId Int      @map("documento_id")
  articleId   Int      @map("article_id") // FK a master articoli
  qtaMancante Decimal? @map("qta_mancante") @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("created_at")

  documento ExportDocument @relation(fields: [documentoId], references: [id], onDelete: Cascade)
  article   ExportArticleMaster  @relation(fields: [articleId], references: [id], onDelete: Restrict)

  @@index([documentoId])
  @@index([articleId])
  @@map("exp_dati_mancanti")
}

// Lanci di produzione associati al DDT
model ExportLaunchData {
  id          Int      @id @default(autoincrement())
  documentoId Int      @map("documento_id")
  lancio      String   @db.VarChar(50)
  articolo    String   @db.VarChar(255)
  paia        Int
  note        String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  documento ExportDocument @relation(fields: [documentoId], references: [id], onDelete: Cascade)

  @@index([documentoId])
  @@map("exp_dati_lanci_ddt")
}

// ==================== SCM (Subcontractors) ====================

model ScmLaboratory {
  id         Int      @id @default(autoincrement())
  codice     String?  @db.VarChar(50)
  nome       String   @db.VarChar(200)
  indirizzo  String?  @db.VarChar(255)
  telefono   String?  @db.VarChar(50)
  email      String?  @db.VarChar(100)
  accessCode String?  @map("access_code") @db.VarChar(50)
  attivo     Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  launches ScmLaunch[]

  @@map("scm_laboratories")
}

model ScmLaunch {
  id            Int       @id @default(autoincrement())
  numero        String    @db.VarChar(50)
  laboratoryId  Int       @map("laboratory_id")
  dataLancio    DateTime  @default(now()) @map("data_lancio")
  dataConsegna  DateTime? @map("data_consegna")
  stato         String    @default("in_corso") @db.VarChar(30)
  blockedReason String?   @map("blocked_reason") @db.Text
  note          String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  laboratory ScmLaboratory      @relation(fields: [laboratoryId], references: [id])
  articles   ScmLaunchArticle[]
  phases     ScmLaunchPhase[]

  @@map("scm_launches")
}

model ScmLaunchArticle {
  id        Int      @id @default(autoincrement())
  launchId  Int      @map("launch_id")
  commessa  String?  @db.VarChar(100)
  modello   String?  @db.VarChar(100)
  colore    String?  @db.VarChar(100)
  quantita  Int      @default(0)
  note      String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  launch ScmLaunch @relation(fields: [launchId], references: [id], onDelete: Cascade)

  @@map("scm_launch_articles")
}

model ScmLaunchPhase {
  id          Int       @id @default(autoincrement())
  launchId    Int       @map("launch_id")
  phaseId     Int?      @map("phase_id")
  nome        String    @db.VarChar(100)
  stato       String    @default("pending") @db.VarChar(30)
  dataInizio  DateTime? @map("data_inizio")
  dataFine    DateTime? @map("data_fine")
  percentuale Int       @default(0)
  note        String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  launch        ScmLaunch             @relation(fields: [launchId], references: [id], onDelete: Cascade)
  standardPhase ScmStandardPhase?     @relation(fields: [phaseId], references: [id])
  tracking      ScmProgressTracking[]

  @@map("scm_launch_phases")
}

model ScmStandardPhase {
  id          Int      @id @default(autoincrement())
  nome        String   @db.VarChar(100)
  codice      String?  @db.VarChar(20)
  descrizione String?  @db.Text
  ordine      Int      @default(0)
  attivo      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  phases ScmLaunchPhase[]

  @@map("scm_standard_phases")
}

model ScmProgressTracking {
  id        Int      @id @default(autoincrement())
  phaseId   Int      @map("phase_id")
  quantita  Int      @default(0)
  data      DateTime @default(now())
  note      String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  phase ScmLaunchPhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  @@map("scm_progress_tracking")
}

model ScmSetting {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(100)
  value     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("scm_settings")
}

// ==================== TRACKING (Aligned to Legacy) ====================

// Collegamenti cartellini-lotti (tabella principale)
model TrackLink {
  id        Int      @id @default(autoincrement())
  cartel    Int      // FK a CoreData.Cartel
  typeId    Int      @map("type_id")
  lot       String   @db.VarChar(255)
  note      String?  @db.VarChar(255)
  timestamp DateTime @default(now())

  type TrackType @relation(fields: [typeId], references: [id])

  @@index([cartel])
  @@index([lot])
  @@index([typeId])
  @@map("track_links")
}

// Tipi di tracking (TOMAIA 1, FODERA 1, etc.)
model TrackType {
  id    Int     @id @default(autoincrement())
  name  String  @db.VarChar(255)
  note  String? @db.VarChar(255)

  links TrackLink[]

  @@map("track_types")
}

// Metadati lotti (DDT, data, note)
model TrackLotInfo {
  lot  String  @id @db.VarChar(255) // PK stringa
  doc  String? @db.VarChar(255) // Numero DDT
  date DateTime? @db.Date
  note String? @db.VarChar(255)

  @@map("track_lots_info")
}

// Metadati ordini (date)
model TrackOrderInfo {
  id     Int       @id @default(autoincrement())
  ordine String    @db.VarChar(255)
  date   DateTime? @db.Date

  @@unique([ordine])
  @@map("track_order_info")
}

// Codici SKU articoli
model TrackSku {
  art String  @id @db.VarChar(255) // PK stringa (codice articolo)
  sku String? @db.VarChar(255)

  @@map("track_sku")
}

// ==================== PRODUCTION ====================

// Fase di produzione (Montaggio, Orlatura, Taglio, etc.)
model ProductionPhase {
  id          Int      @id @default(autoincrement())
  nome        String   @db.VarChar(100)
  codice      String?  @unique @db.VarChar(20)
  colore      String?  @db.VarChar(20) // Colore per UI (blue, green, purple, etc.)
  icona       String?  @db.VarChar(50) // Icona FontAwesome
  descrizione String?  @db.Text
  attivo      Boolean  @default(true)
  ordine      Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  reparti ProductionDepartment[]

  @@map("prod_phases")
}

// Reparto di produzione (Manovia 1, Orlatura 1, etc.)
model ProductionDepartment {
  id          Int      @id @default(autoincrement())
  phaseId     Int      @map("phase_id")
  nome        String   @db.VarChar(100)
  codice      String?  @db.VarChar(20)
  descrizione String?  @db.Text
  attivo      Boolean  @default(true)
  ordine      Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  phase  ProductionPhase   @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  valori ProductionValue[]

  @@map("prod_departments")
}

// Record giornaliero di produzione (una riga per data)
model ProductionRecord {
  id             Int      @id @default(autoincrement())
  productionDate DateTime @unique @map("production_date") @db.Date

  // Metadata
  createdBy Int?     @map("created_by")
  updatedBy Int?     @map("updated_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  creator User? @relation("ProductionCreator", fields: [createdBy], references: [id])
  updater User? @relation("ProductionUpdater", fields: [updatedBy], references: [id])
  valori  ProductionValue[]

  @@map("prod_records")
}

// Valori di produzione per reparto
model ProductionValue {
  id           Int      @id @default(autoincrement())
  recordId     Int      @map("record_id")
  departmentId Int      @map("department_id")
  valore       Int      @default(0)
  note         String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  record     ProductionRecord     @relation(fields: [recordId], references: [id], onDelete: Cascade)
  department ProductionDepartment @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([recordId, departmentId])
  @@map("prod_values")
}

// ==================== MRP ====================

model MrpMaterial {
  id         Int      @id @default(autoincrement())
  codice     String   @unique @db.VarChar(100)
  nome       String   @db.VarChar(200)
  categoryId Int?     @map("category_id")
  unita      String   @default("PZ") @db.VarChar(20)
  scorta     Int      @default(0)
  giacenza   Int      @default(0)
  leadTime   Int      @default(0) @map("lead_time")
  fornitore  String?  @db.VarChar(200)
  prezzo     Decimal? @db.Decimal(10, 2)
  note       String?  @db.Text
  attivo     Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  category     MrpCategory?     @relation(fields: [categoryId], references: [id])
  orders       MrpOrder[]
  arrivals     MrpArrival[]
  requirements MrpRequirement[]

  @@map("mrp_materials")
}

model MrpCategory {
  id          Int      @id @default(autoincrement())
  nome        String   @db.VarChar(100)
  codice      String?  @db.VarChar(20)
  descrizione String?  @db.Text
  attivo      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  materials MrpMaterial[]

  @@map("mrp_categories")
}

model MrpOrder {
  id           Int       @id @default(autoincrement())
  materialId   Int       @map("material_id")
  quantita     Int
  dataOrdine   DateTime  @default(now()) @map("data_ordine")
  dataConsegna DateTime? @map("data_consegna")
  stato        String    @default("ordinato") @db.VarChar(30)
  fornitore    String?   @db.VarChar(200)
  riferimento  String?   @db.VarChar(100)
  note         String?   @db.Text
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  material MrpMaterial @relation(fields: [materialId], references: [id])

  @@map("mrp_orders")
}

model MrpArrival {
  id          Int      @id @default(autoincrement())
  materialId  Int      @map("material_id")
  quantita    Int
  dataArrivo  DateTime @default(now()) @map("data_arrivo")
  riferimento String?  @db.VarChar(100)
  note        String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  material MrpMaterial @relation(fields: [materialId], references: [id])

  @@map("mrp_arrivals")
}

model MrpRequirement {
  id             Int      @id @default(autoincrement())
  materialId     Int      @map("material_id")
  commessa       String?  @db.VarChar(100)
  quantita       Int
  dataFabbisogno DateTime @map("data_fabbisogno")
  stato          String   @default("pending") @db.VarChar(30)
  note           String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  material MrpMaterial @relation(fields: [materialId], references: [id])

  @@map("mrp_requirements")
}

// ==================== WIDGETS ====================

model AvailableWidget {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)
  title       String   @db.VarChar(100)
  description String?  @db.Text
  icon        String?  @db.VarChar(50)
  category    String?  @db.VarChar(50)
  minWidth    Int      @default(1) @map("min_width")
  minHeight   Int      @default(1) @map("min_height")
  attivo      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  userWidgets UserWidget[]

  @@map("widg_available")
}

model UserWidget {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  widgetId  Int      @map("widget_id")
  x         Int      @default(0)
  y         Int      @default(0)
  width     Int      @default(1)
  height    Int      @default(1)
  config    Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user   User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  widget AvailableWidget @relation(fields: [widgetId], references: [id], onDelete: Cascade)

  @@map("widg_usermap")
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  type      String    @db.VarChar(50)
  title     String    @db.VarChar(200)
  message   String?   @db.Text
  link      String?   @db.VarChar(255)
  read      Boolean   @default(false)
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("auth_notifications")
}

// ==================== JOBS / SPOOL ====================

model Job {
  id           String    @id @default(uuid()) @db.Char(36)
  userId       Int       @map("user_id")
  type         String    @db.VarChar(100)
  payload      Json
  status       String    @db.VarChar(20) // queued, running, done, failed
  progress     Int       @default(0)
  outputPath   String?   @map("output_path") @db.VarChar(255)
  outputName   String?   @map("output_name") @db.VarChar(255)
  outputMime   String?   @map("output_mime") @db.VarChar(100)
  outputSize   Int?      @map("output_size")
  errorMessage String?   @map("error_message") @db.Text
  startedAt    DateTime? @map("started_at")
  finishedAt   DateTime? @map("finished_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("core_jobs")
}

// ==================== CRON ====================

model CronLog {
  id           Int       @id @default(autoincrement())
  jobClass     String    @map("job_class") @db.VarChar(100)
  name         String    @db.VarChar(100)
  status       String    @db.VarChar(20)
  startedAt    DateTime  @map("started_at")
  completedAt  DateTime? @map("completed_at")
  durationMs   Int?      @map("duration_ms")
  errorMessage String?   @map("error_message") @db.Text
  output       String?   @db.Text
  createdAt    DateTime  @default(now()) @map("created_at")

  @@map("cron_logs")
}

// ==================== INWORK (Mobile Operators) ====================

model InworkOperator {
  id        Int       @id @default(autoincrement())
  nome      String    @db.VarChar(100)
  cognome   String?   @db.VarChar(100)
  matricola String?   @unique @db.VarChar(50)
  pin       String?   @db.VarChar(10)
  password  String?   @db.VarChar(255)
  email     String?   @db.VarChar(100)
  reparto   String?   @db.VarChar(100)
  ruolo     String?   @db.VarChar(50)
  attivo    Boolean   @default(true)
  lastLogin DateTime? @map("last_login")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  modulePermissions InworkModulePermission[]

  @@map("inwork_operators")
}

model InworkModulePermission {
  id         Int      @id @default(autoincrement())
  operatorId Int      @map("operator_id")
  module     String   @db.VarChar(50)
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  operator InworkOperator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  @@unique([operatorId, module])
  @@map("inwork_module_permissions")
}
