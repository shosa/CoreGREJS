generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== AUTH ====================

model User {
  id           Int       @id @default(autoincrement())
  userName     String    @unique @map("user_name") @db.VarChar(50)
  nome         String    @db.VarChar(100)
  password     String    @db.VarChar(255)
  mail         String?   @db.VarChar(100)
  mailPassword String?   @map("mail_password") @db.VarChar(255)
  lastLogin    DateTime? @map("last_login")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  permissions   Permission?
  activityLogs  ActivityLog[]
  widgetConfigs AuthWidgetConfig[]
  jobs          Job[]
  minioFiles    MinioFile[]

  // Production records created/updated by this user
  productionRecordsCreated ProductionRecord[] @relation("ProductionCreator")
  productionRecordsUpdated ProductionRecord[] @relation("ProductionUpdater")

  // Repairs
  riparazioni Riparazione[]

  @@map("auth_users")
}

model Permission {
  id       Int  @id @default(autoincrement())
  userId   Int  @unique @map("id_utente")
  permessi Json

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("auth_permissions")
}

// ==================== CORE ====================

model ActivityLog {
  id          Int      @id @default(autoincrement())
  userId      Int?     @map("user_id")
  module      String   @default("system") @db.VarChar(50) // produzione, riparazioni, users, etc.
  action      String   @db.VarChar(100) // create, update, delete, view, login, etc.
  entity      String?  @db.VarChar(100) // Nome entità (User, ProductionRecord, etc.)
  entityId    String?  @map("entity_id") @db.VarChar(100) // ID dell'entità modificata
  description String?  @db.Text
  metadata    Json? // Dati aggiuntivi (before/after values, etc.)
  ipAddress   String?  @map("ip_address") @db.VarChar(45)
  userAgent   String?  @map("user_agent") @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([module])
  @@index([action])
  @@index([createdAt])
  @@map("core_log")
}

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(100)
  value     String?  @db.Text
  type      String   @default("string") @db.VarChar(20)
  group     String   @default("general") @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("core_settings")
}

// Tabella principale dati produzione - struttura LEGACY
model CoreData {
  id                  Int     @id @default(autoincrement())
  st                  String? @map("St") @db.VarChar(3)
  ordine              Int?    @map("Ordine")
  rg                  Int?    @map("Rg")
  cCli                Int?    @map("CCli")
  ragioneSociale      String? @map("Ragione Sociale") @db.VarChar(35)
  cartel              Int?    @unique @map("Cartel")
  commessaCli         String? @map("Commessa Cli") @db.VarChar(20)
  po                  String? @map("PO") @db.VarChar(255)
  articolo            String  @map("Articolo") @db.VarChar(255)
  descrizioneArticolo String  @map("Descrizione Articolo") @db.VarChar(255)
  nu                  String? @map("Nu") @db.VarChar(2)
  marcaEtich          String? @map("Marca Etich") @db.VarChar(13)
  ln                  String? @map("Ln") @db.VarChar(2)
  p01                 Int?    @map("P01")
  p02                 Int?    @map("P02")
  p03                 Int?    @map("P03")
  p04                 Int?    @map("P04")
  p05                 Int?    @map("P05")
  p06                 Int?    @map("P06")
  p07                 Int?    @map("P07")
  p08                 Int?    @map("P08")
  p09                 Int?    @map("P09")
  p10                 Int?    @map("P10")
  p11                 Int?    @map("P11")
  p12                 Int?    @map("P12")
  p13                 Int?    @map("P13")
  p14                 Int?    @map("P14")
  p15                 Int?    @map("P15")
  p16                 Int?    @map("P16")
  p17                 Int?    @map("P17")
  p18                 Int?    @map("P18")
  p19                 Int?    @map("P19")
  p20                 Int?    @map("P20")
  tot                 Int?    @map("Tot")

  @@index([ordine])
  @@index([commessaCli])
  @@index([articolo])
  @@map("core_dati")
}

model CoreAnagrafica {
  id        Int      @id @default(autoincrement())
  codice    String?  @db.VarChar(50)
  nome      String?  @db.VarChar(200)
  tipo      String?  @db.VarChar(50)
  indirizzo String?  @db.VarChar(255)
  telefono  String?  @db.VarChar(50)
  email     String?  @db.VarChar(100)
  piva      String?  @db.VarChar(20)
  cf        String?  @db.VarChar(20)
  note      String?  @db.Text
  attivo    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("core_anag")
}

// ==================== RIPARAZIONI ====================

model Riparazione {
  id            Int    @id @default(autoincrement())
  idRiparazione String @unique @map("id_riparazione") @db.VarChar(10)

  // Riferimenti
  cartellino String? @db.VarChar(50)
  userId     Int?    @map("user_id")
  numerataId Int?    @map("numerata_id")

  // 20 colonne taglie (quantità per ogni taglia)
  p01 Int @default(0)
  p02 Int @default(0)
  p03 Int @default(0)
  p04 Int @default(0)
  p05 Int @default(0)
  p06 Int @default(0)
  p07 Int @default(0)
  p08 Int @default(0)
  p09 Int @default(0)
  p10 Int @default(0)
  p11 Int @default(0)
  p12 Int @default(0)
  p13 Int @default(0)
  p14 Int @default(0)
  p15 Int @default(0)
  p16 Int @default(0)
  p17 Int @default(0)
  p18 Int @default(0)
  p19 Int @default(0)
  p20 Int @default(0)

  qtaTotale Int @default(0) @map("qta_totale")

  // Info riparazione
  causale       String? @db.Text
  laboratorioId Int?    @map("laboratorio_id") // Destinazione
  repartoId     Int?    @map("reparto_id") // Provenienza

  // Stato e date
  data         DateTime  @default(now())
  completa     Boolean   @default(false)
  dataChiusura DateTime? @map("data_chiusura")

  // Note aggiuntive
  note String? @db.Text

  // Timestamp
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relazioni
  user        User?        @relation(fields: [userId], references: [id])
  numerata    Numerata?    @relation(fields: [numerataId], references: [id])
  laboratorio Laboratorio? @relation(fields: [laboratorioId], references: [id])
  reparto     Reparto?     @relation(fields: [repartoId], references: [id])

  @@map("rip_riparazioni")
}

model Reparto {
  id          Int      @id @default(autoincrement())
  nome        String   @db.VarChar(100)
  codice      String?  @db.VarChar(20)
  descrizione String?  @db.Text
  attivo      Boolean  @default(true)
  ordine      Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  riparazioni Riparazione[]

  @@map("rip_reparti")
}


model Laboratorio {
  id        Int      @id @default(autoincrement())
  nome      String   @db.VarChar(100)
  codice    String?  @db.VarChar(20)
  indirizzo String?  @db.VarChar(255)
  telefono  String?  @db.VarChar(50)
  email     String?  @db.VarChar(100)
  attivo    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  riparazioni Riparazione[]

  @@map("rip_laboratori")
}

model Numerata {
  id         Int    @id @default(autoincrement())
  idNumerata String @unique @map("id_numerata") @db.VarChar(2) // NU code (text, max 2 chars)

  // 20 colonne per i nomi delle taglie
  n01 String? @db.VarChar(10)
  n02 String? @db.VarChar(10)
  n03 String? @db.VarChar(10)
  n04 String? @db.VarChar(10)
  n05 String? @db.VarChar(10)
  n06 String? @db.VarChar(10)
  n07 String? @db.VarChar(10)
  n08 String? @db.VarChar(10)
  n09 String? @db.VarChar(10)
  n10 String? @db.VarChar(10)
  n11 String? @db.VarChar(10)
  n12 String? @db.VarChar(10)
  n13 String? @db.VarChar(10)
  n14 String? @db.VarChar(10)
  n15 String? @db.VarChar(10)
  n16 String? @db.VarChar(10)
  n17 String? @db.VarChar(10)
  n18 String? @db.VarChar(10)
  n19 String? @db.VarChar(10)
  n20 String? @db.VarChar(10)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  riparazioni Riparazione[]

  @@map("rip_idnumerate")
}

// ==================== QUALITY CONTROL ====================

model QualityRecord {
  id              Int                 @id @default(autoincrement())
  numeroCartellino String             @map("numero_cartellino") @db.VarChar(50)
  reparto         String?             @db.VarChar(255)
  dataControllo   DateTime            @default(now()) @map("data_controllo")
  operatore       String              @db.VarChar(255)
  tipoCq          String              @default("INTERNO") @map("tipo_cq") @db.VarChar(20)
  paiaTotali      Int                 @map("paia_totali")
  codArticolo     String              @map("cod_articolo") @db.VarChar(50)
  articolo        String              @db.VarChar(255)
  linea           String              @db.VarChar(2)
  note            String?             @db.VarChar(10000)
  haEccezioni     Boolean             @default(false) @map("ha_eccezioni")

  exceptions      QualityException[]

  @@index([dataControllo])
  @@index([reparto])
  @@index([operatore])
  @@map("cq_records")
}

model QualityDepartment {
  id            Int      @id @default(autoincrement())
  nomeReparto   String   @unique @map("nome_reparto") @db.VarChar(255)
  attivo        Boolean  @default(true)
  ordine        Int      @default(0)
  dataCreazione DateTime @default(now()) @map("data_creazione")

  @@map("cq_departments")
}

model QualityDefectType {
  id            Int      @id @default(autoincrement())
  descrizione   String   @unique @db.VarChar(255)
  categoria     String?  @db.VarChar(100)
  attivo        Boolean  @default(true)
  ordine        Int      @default(0)
  dataCreazione DateTime @default(now()) @map("data_creazione")

  @@map("cq_deftypes")
}

model QualityException {
  id             Int      @id @default(autoincrement())
  cartellinoId   Int      @map("cartellino_id")
  taglia         String   @db.VarChar(10)
  tipoDifetto    String   @map("tipo_difetto") @db.VarChar(255)
  noteOperatore  String?  @map("note_operatore") @db.VarChar(1000)
  fotoPath       String?  @db.VarChar(500)
  dataCreazione  DateTime @default(now()) @map("data_creazione")

  record QualityRecord @relation(fields: [cartellinoId], references: [id], onDelete: Cascade)

  @@index([cartellinoId])
  @@map("cq_exceptions")
}

// ==================== EXPORT / DDT ====================

// ==================== EXPORT/DDT (Modernizzato) ====================

// Tabella master articoli (normalizzata, no duplicati)
model ExportArticleMaster {
  id             Int      @id @default(autoincrement())
  codiceArticolo String   @unique @map("codice_articolo") @db.VarChar(255)
  descrizione    String?  @db.VarChar(255)
  voceDoganale   String?  @map("voce_doganale") @db.VarChar(50)
  um             String?  @db.VarChar(10)
  prezzoUnitario Decimal? @map("prezzo_unitario") @db.Decimal(10, 3)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  righe    ExportDocumentItem[]
  mancanti ExportMissingData[]

  @@index([codiceArticolo])
  @@map("exp_articoli_master")
}

// Terzisti (fornitori/subfornitori)
model ExportTerzista {
  id             Int      @id @default(autoincrement())
  ragioneSociale String   @map("ragione_sociale") @db.VarChar(255)
  indirizzo1     String?  @map("indirizzo_1") @db.VarChar(255)
  indirizzo2     String?  @map("indirizzo_2") @db.VarChar(255)
  indirizzo3     String?  @map("indirizzo_3") @db.VarChar(255)
  nazione        String?  @db.VarChar(100)
  consegna       String?  @db.Text
  autorizzazione String?  @db.VarChar(255)
  attivo         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  documenti ExportDocument[]

  @@index([ragioneSociale])
  @@map("exp_terzisti")
}

// Documenti DDT
model ExportDocument {
  id             Int      @id @default(autoincrement())
  progressivo    String   @unique @db.VarChar(50)
  terzistaId     Int      @map("terzista_id")
  data           DateTime @db.Date
  stato          String   @default("Aperto") @db.VarChar(20) // Aperto, Chiuso
  firstBoot      Boolean  @default(true) @map("first_boot")
  autorizzazione String?  @db.VarChar(255)
  commento       String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  terzista ExportTerzista        @relation(fields: [terzistaId], references: [id], onDelete: Restrict)
  righe    ExportDocumentItem[]
  piede    ExportDocumentFooter?
  mancanti ExportMissingData[]
  lanci    ExportLaunchData[]

  @@index([terzistaId])
  @@index([stato])
  @@index([createdAt])
  @@index([stato, createdAt])
  @@map("exp_documenti")
}

// Righe documento (referenziano articoli master)
model ExportDocumentItem {
  id                Int      @id @default(autoincrement())
  documentoId       Int      @map("documento_id")
  articleId         Int?     @map("article_id") // FK a master, NULL se riga libera
  qtaOriginale      Decimal? @default(0) @map("qta_originale") @db.Decimal(10, 2)
  qtaReale          Decimal? @default(0) @map("qta_reale") @db.Decimal(10, 2)
  isMancante        Boolean  @default(false) @map("is_mancante")
  rifMancante       String?  @map("rif_mancante") @db.VarChar(50)
  tipoRiga          String   @default("articolo") @map("tipo_riga") @db.VarChar(20) // articolo, libera
  // Campi per righe libere (senza FK article)
  codiceLibero      String?  @map("codice_libero") @db.VarChar(255)
  descrizioneLibera String?  @map("descrizione_libera") @db.VarChar(255)
  voceLibera        String?  @map("voce_libera") @db.VarChar(50)
  umLibera          String?  @map("um_libera") @db.VarChar(10)
  prezzoLibero      Decimal? @map("prezzo_libero") @db.Decimal(10, 3)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  documento ExportDocument       @relation(fields: [documentoId], references: [id], onDelete: Cascade)
  article   ExportArticleMaster? @relation(fields: [articleId], references: [id], onDelete: SetNull)

  @@index([documentoId])
  @@index([articleId])
  @@map("exp_righe_documento")
}

// Piede documento (footer) - con JSON array per voci doganali
model ExportDocumentFooter {
  id            Int      @id @default(autoincrement())
  documentoId   Int      @unique @map("documento_id")
  aspettoColli  String?  @map("aspetto_colli") @db.VarChar(255)
  nColli        Int?     @map("n_colli")
  totPesoLordo  Decimal? @map("tot_peso_lordo") @db.Decimal(10, 2)
  totPesoNetto  Decimal? @map("tot_peso_netto") @db.Decimal(10, 2)
  trasportatore String?  @db.VarChar(255)
  consegnatoPer String?  @map("consegnato_per") @db.Text
  // Array JSON: [{ voce: "56031480", peso: 123.45 }, ...]
  vociDoganali  Json?    @map("voci_doganali")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  documento ExportDocument @relation(fields: [documentoId], references: [id], onDelete: Cascade)

  @@map("exp_piede_documenti")
}

// Dati mancanti da altri DDT (per tracciare merce non ancora spedita)
model ExportMissingData {
  id          Int      @id @default(autoincrement())
  documentoId Int      @map("documento_id")
  articleId   Int      @map("article_id") // FK a master articoli
  qtaMancante Decimal? @map("qta_mancante") @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("created_at")

  documento ExportDocument      @relation(fields: [documentoId], references: [id], onDelete: Cascade)
  article   ExportArticleMaster @relation(fields: [articleId], references: [id], onDelete: Restrict)

  @@index([documentoId])
  @@index([articleId])
  @@map("exp_dati_mancanti")
}

// Lanci di produzione associati al DDT
model ExportLaunchData {
  id          Int      @id @default(autoincrement())
  documentoId Int      @map("documento_id")
  lancio      String   @db.VarChar(50)
  articolo    String   @db.VarChar(255)
  paia        Int
  note        String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  documento ExportDocument @relation(fields: [documentoId], references: [id], onDelete: Cascade)

  @@index([documentoId])
  @@map("exp_dati_lanci_ddt")
}

// Aspetto Merce (opzioni per piede documento)
model ExportAspettoMerce {
  id          Int      @id @default(autoincrement())
  descrizione String   @db.VarChar(255)
  codice      String?  @unique @db.VarChar(50)
  attivo      Boolean  @default(true)
  ordine      Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("exp_aspetto_merce")
}

// Vettori/Trasportatori (opzioni per piede documento)
model ExportVettore {
  id             Int      @id @default(autoincrement())
  ragioneSociale String   @map("ragione_sociale") @db.VarChar(255)
  codice         String?  @unique @db.VarChar(50)
  indirizzo      String?  @db.VarChar(255)
  telefono       String?  @db.VarChar(50)
  attivo         Boolean  @default(true)
  ordine         Int      @default(0)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("exp_vettori")
}

// ==================== SCM (Subcontractors) ====================

model ScmLaboratory {
  id         Int      @id @default(autoincrement())
  codice     String?  @db.VarChar(50)
  nome       String   @db.VarChar(200)
  indirizzo  String?  @db.VarChar(255)
  telefono   String?  @db.VarChar(50)
  email      String?  @db.VarChar(100)
  accessCode String?  @map("access_code") @db.VarChar(50)
  attivo     Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  launches ScmLaunch[]

  @@map("scm_laboratories")
}

model ScmLaunch {
  id            Int       @id @default(autoincrement())
  numero        String    @db.VarChar(50)
  laboratoryId  Int       @map("laboratory_id")
  dataLancio    DateTime  @default(now()) @map("data_lancio")
  dataConsegna  DateTime? @map("data_consegna")
  stato         String    @default("in_corso") @db.VarChar(30)
  blockedReason String?   @map("blocked_reason") @db.Text
  note          String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  laboratory ScmLaboratory      @relation(fields: [laboratoryId], references: [id])
  articles   ScmLaunchArticle[]

  @@map("scm_launches")
}

model ScmLaunchArticle {
  id        Int      @id @default(autoincrement())
  launchId  Int      @map("launch_id")
  commessa  String?  @db.VarChar(100)
  modello   String?  @db.VarChar(100)
  colore    String?  @db.VarChar(100)
  quantita  Int      @default(0)
  note      String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  launch ScmLaunch         @relation(fields: [launchId], references: [id], onDelete: Cascade)
  phases ScmArticlePhase[]

  @@map("scm_launch_articles")
}

model ScmArticlePhase {
  id         Int       @id @default(autoincrement())
  articleId  Int       @map("article_id")
  phaseId    Int?      @map("phase_id")
  nome       String    @db.VarChar(100)
  stato      String    @default("pending") @db.VarChar(30)
  dataInizio DateTime? @map("data_inizio")
  dataFine   DateTime? @map("data_fine")
  note       String?   @db.Text
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  article       ScmLaunchArticle      @relation(fields: [articleId], references: [id], onDelete: Cascade)
  standardPhase ScmStandardPhase?     @relation(fields: [phaseId], references: [id])
  tracking      ScmProgressTracking[]

  @@map("scm_article_phases")
}

model ScmStandardPhase {
  id          Int      @id @default(autoincrement())
  nome        String   @db.VarChar(100)
  codice      String?  @db.VarChar(20)
  descrizione String?  @db.Text
  ordine      Int      @default(0)
  attivo      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  phases ScmArticlePhase[]

  @@map("scm_standard_phases")
}

model ScmProgressTracking {
  id        Int      @id @default(autoincrement())
  phaseId   Int      @map("phase_id")
  quantita  Int      @default(0)
  data      DateTime @default(now())
  note      String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  phase ScmArticlePhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  @@map("scm_progress_tracking")
}

model ScmSetting {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(100)
  value     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("scm_settings")
}

// ==================== TRACKING (Aligned to Legacy) ====================

// Collegamenti cartellini-lotti (tabella principale)
model TrackLink {
  id        Int      @id @default(autoincrement())
  cartel    Int // FK a CoreData.Cartel
  typeId    Int      @map("type_id")
  lot       String   @db.VarChar(255)
  note      String?  @db.VarChar(255)
  timestamp DateTime @default(now())

  type TrackType @relation(fields: [typeId], references: [id])

  @@index([cartel])
  @@index([lot])
  @@index([typeId])
  @@map("track_links")
}

// Tipi di tracking (TOMAIA 1, FODERA 1, etc.)
model TrackType {
  id   Int     @id @default(autoincrement())
  name String  @db.VarChar(255)
  note String? @db.VarChar(255)

  links TrackLink[]

  @@map("track_types")
}

// Metadati lotti (DDT, data, note)
model TrackLotInfo {
  lot  String    @id @db.VarChar(255) // PK stringa
  doc  String?   @db.VarChar(255) // Numero DDT
  date DateTime? @db.Date
  note String?   @db.VarChar(255)

  @@map("track_lots_info")
}

// Metadati ordini (date)
model TrackOrderInfo {
  id     Int       @id @default(autoincrement())
  ordine String    @db.VarChar(255)
  date   DateTime? @db.Date

  @@unique([ordine])
  @@map("track_order_info")
}

// Codici SKU articoli
model TrackSku {
  art String  @id @db.VarChar(255) // PK stringa (codice articolo)
  sku String? @db.VarChar(255)

  @@map("track_sku")
}

// Archivio storico collegamenti (compattamento)
// Denormalizzato: porta con sé tutti i dati da CoreData, TrackLotInfo, TrackOrderInfo, TrackSku
model TrackLinkArchive {
  id          Int      @id @default(autoincrement())
  // dati originali TrackLink
  cartel      Int
  typeId      Int      @map("type_id")
  typeName    String   @db.VarChar(255)
  lot         String   @db.VarChar(255)
  note        String?  @db.VarChar(255)
  timestamp   DateTime
  // da CoreData (snapshot al momento del compattamento)
  commessa    String?  @db.VarChar(20)
  articolo    String?  @db.VarChar(255)
  descrizione String?  @db.VarChar(255)
  ragioneSoc  String?  @map("ragione_soc") @db.VarChar(35)
  ordine      Int?
  // da TrackLotInfo
  lotDoc      String?  @map("lot_doc") @db.VarChar(255)
  lotDate     DateTime? @map("lot_date") @db.Date
  lotNote     String?  @map("lot_note") @db.VarChar(255)
  // da TrackOrderInfo
  orderDate   DateTime? @map("order_date") @db.Date
  // da TrackSku
  sku         String?  @db.VarChar(255)
  // metadato archivio
  archivedAt  DateTime @default(now()) @map("archived_at")

  @@index([cartel])
  @@index([lot])
  @@index([timestamp])
  @@index([commessa])
  @@map("track_links_archive")
}

// ==================== PRODUCTION ====================

// Fase di produzione (Montaggio, Orlatura, Taglio, etc.)
model ProductionPhase {
  id          Int      @id @default(autoincrement())
  nome        String   @db.VarChar(100)
  codice      String?  @unique @db.VarChar(20)
  colore      String?  @db.VarChar(20) // Colore per UI (blue, green, purple, etc.)
  icona       String?  @db.VarChar(50) // Icona FontAwesome
  descrizione String?  @db.Text
  attivo      Boolean  @default(true)
  ordine      Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  reparti ProductionDepartment[]

  @@map("prod_phases")
}

// Reparto di produzione (Manovia 1, Orlatura 1, etc.)
model ProductionDepartment {
  id          Int      @id @default(autoincrement())
  phaseId     Int      @map("phase_id")
  nome        String   @db.VarChar(100)
  codice      String?  @db.VarChar(20)
  descrizione String?  @db.Text
  attivo      Boolean  @default(true)
  ordine      Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  phase            ProductionPhase          @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  valori           ProductionValue[]
  analiticaMappings AnaliticaRepartoMapping[]

  @@map("prod_departments")
}

// Record giornaliero di produzione (una riga per data)
model ProductionRecord {
  id             Int      @id @default(autoincrement())
  productionDate DateTime @unique @map("production_date") @db.Date

  // Metadata
  createdBy Int?     @map("created_by")
  updatedBy Int?     @map("updated_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  creator User?             @relation("ProductionCreator", fields: [createdBy], references: [id])
  updater User?             @relation("ProductionUpdater", fields: [updatedBy], references: [id])
  valori  ProductionValue[]

  @@map("prod_records")
}

// Valori di produzione per reparto
model ProductionValue {
  id           Int      @id @default(autoincrement())
  recordId     Int      @map("record_id")
  departmentId Int      @map("department_id")
  valore       Int      @default(0)
  note         String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  record     ProductionRecord     @relation(fields: [recordId], references: [id], onDelete: Cascade)
  department ProductionDepartment @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([recordId, departmentId])
  @@map("prod_values")
}


// ==================== WIDGETS ====================

model AuthWidgetConfig {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  widgetId  String   @map("widget_id") @db.VarChar(50)
  enabled   Boolean  @default(true)
  x         Int      @default(0)
  y         Int      @default(0)
  w         Int      @default(1)
  h         Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, widgetId])
  @@map("auth_widget_config")
}

// ==================== NOTIFICATIONS ====================

// ==================== JOBS / SPOOL ====================

model Job {
  id           String    @id @default(uuid()) @db.Char(36)
  userId       Int       @map("user_id")
  type         String    @db.VarChar(100)
  payload      Json
  status       String    @db.VarChar(20) // queued, running, done, failed
  progress     Int       @default(0)
  outputPath   String?   @map("output_path") @db.VarChar(255)
  outputName   String?   @map("output_name") @db.VarChar(255)
  outputMime   String?   @map("output_mime") @db.VarChar(100)
  outputSize   Int?      @map("output_size")
  errorMessage String?   @map("error_message") @db.Text
  startedAt    DateTime? @map("started_at")
  finishedAt   DateTime? @map("finished_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  minioFiles MinioFile[]

  @@index([userId])
  @@map("core_jobs")
}

// ==================== CRON ====================

model CronLog {
  id           Int       @id @default(autoincrement())
  jobClass     String    @map("job_class") @db.VarChar(100)
  name         String    @db.VarChar(100)
  status       String    @db.VarChar(20)
  startedAt    DateTime  @map("started_at")
  completedAt  DateTime? @map("completed_at")
  durationMs   Int?      @map("duration_ms")
  errorMessage String?   @map("error_message") @db.Text
  output       String?   @db.Text
  createdAt    DateTime  @default(now()) @map("created_at")

  @@map("cron_logs")
}

// ==================== INWORK (Mobile Operators) ====================

model InworkOperator {
  id        Int       @id @default(autoincrement())
  nome      String    @db.VarChar(100)
  cognome   String?   @db.VarChar(100)
  matricola String?   @unique @db.VarChar(50)
  pin       String?   @db.VarChar(10)
  password  String?   @db.VarChar(255)
  email     String?   @db.VarChar(100)
  reparto   String?   @db.VarChar(100)
  ruolo     String?   @db.VarChar(50)
  attivo    Boolean   @default(true)
  lastLogin DateTime? @map("last_login")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  modulePermissions InworkModulePermission[]

  @@map("inwork_operators")
}

model InworkModulePermission {
  id         Int      @id @default(autoincrement())
  operatorId Int      @map("operator_id")
  module     String   @db.VarChar(50)
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  operator InworkOperator @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  @@unique([operatorId, module])
  @@map("inwork_module_permissions")
}

model InworkAvailableModule {
  id          Int      @id @default(autoincrement())
  moduleId    String   @unique @map("module_id") @db.VarChar(50)
  moduleName  String   @map("module_name") @db.VarChar(100)
  descrizione String?  @db.VarChar(255)
  attivo      Boolean  @default(true)
  ordine      Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("inwork_available_modules")
}

// ==================== ANALITICHE ====================

// Record principale importato da Excel ERP
model AnaliticaRecord {
  id               Int      @id @default(autoincrement())

  // Campi estratti dall'Excel ERP
  tipoDocumento    String?  @map("tipo_documento") @db.VarChar(50)
  numeroDocumento  String?  @map("numero_documento") @db.VarChar(50)
  dataDocumento    DateTime? @map("data_documento") @db.Date
  linea            String?  @db.VarChar(100) // DESCRIZIONE dopo LINEA
  articolo         String?  @db.VarChar(255)
  descrizioneArt   String?  @map("descrizione_art") @db.VarChar(255) // DESCRIZIONE dopo ARTICOLO
  tipologiaOrdine  String?  @map("tipologia_ordine") @db.VarChar(100)
  quantita         Decimal? @db.Decimal(10, 2)
  prezzoUnitario   Decimal? @map("prezzo_unitario") @db.Decimal(10, 3)

  // Campi aggiuntivi per analisi costi
  prodottoEstero   Boolean? @map("prodotto_estero") // flag ITALIA/ESTERO (null = non definito)
  repartoId        Int?     @map("reparto_id") // se Italia
  repartoFinaleId  Int?     @map("reparto_finale_id")
  costoTaglio      Decimal? @map("costo_taglio") @db.Decimal(10, 3)
  costoOrlatura    Decimal? @map("costo_orlatura") @db.Decimal(10, 3)
  costoStrobel     Decimal? @map("costo_strobel") @db.Decimal(10, 3)
  altriCosti       Decimal? @map("altri_costi") @db.Decimal(10, 3)
  costoMontaggio   Decimal? @map("costo_montaggio") @db.Decimal(10, 3)

  // Riferimento all'import
  importId         Int?     @map("import_id")

  // Timestamp
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relazioni
  reparto          AnaliticaReparto?  @relation("RepartoItalia", fields: [repartoId], references: [id])
  repartoFinale    AnaliticaReparto?  @relation("RepartoFinale", fields: [repartoFinaleId], references: [id])
  import           AnaliticaImport?   @relation(fields: [importId], references: [id], onDelete: SetNull)

  @@index([dataDocumento])
  @@index([articolo])
  @@index([tipoDocumento])
  @@index([importId])
  @@map("ana_records")
}

// Reparti per analisi costi
model AnaliticaReparto {
  id             Int      @id @default(autoincrement())
  nome           String   @db.VarChar(100)
  codice         String?  @unique @db.VarChar(20)
  descrizione    String?  @db.Text
  attivo         Boolean  @default(true)
  ordine         Int      @default(0)
  costiAssociati String?  @map("costi_associati") @db.Text // JSON array: ["costoTaglio", "costoOrlatura", ...]
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  recordsReparto       AnaliticaRecord[]        @relation("RepartoItalia")
  recordsRepartoFinale AnaliticaRecord[]        @relation("RepartoFinale")
  mappings             AnaliticaRepartoMapping[]

  @@map("ana_reparti")
}

// Mappatura reparti analitiche → reparti produzione
model AnaliticaRepartoMapping {
  id                 Int      @id @default(autoincrement())
  analiticaRepartoId Int      @map("analitica_reparto_id")
  prodDepartmentId   Int      @map("prod_department_id")
  createdAt          DateTime @default(now()) @map("created_at")

  analiticaReparto AnaliticaReparto     @relation(fields: [analiticaRepartoId], references: [id], onDelete: Cascade)
  prodDepartment   ProductionDepartment @relation(fields: [prodDepartmentId], references: [id], onDelete: Cascade)

  @@unique([prodDepartmentId])
  @@index([analiticaRepartoId])
  @@map("ana_reparto_mappings")
}

// Storico importazioni Excel
model AnaliticaImport {
  id           Int      @id @default(autoincrement())
  fileName     String   @map("file_name") @db.VarChar(255)
  fileSize     Int?     @map("file_size")
  recordsCount Int      @default(0) @map("records_count")
  stato        String   @default("completato") @db.VarChar(20) // completato, errore, in_corso
  errorMessage String?  @map("error_message") @db.Text
  userId       Int?     @map("user_id")
  createdAt    DateTime @default(now()) @map("created_at")

  records AnaliticaRecord[]

  @@index([createdAt])
  @@map("ana_imports")
}

// ==================== FILE MANAGER ====================

model MinioFile {
  id         Int      @id @default(autoincrement())
  bucket     String   @db.VarChar(100)
  objectKey  String   @map("object_key") @db.VarChar(500)
  fileName   String   @map("file_name") @db.VarChar(255)
  fileSize   BigInt   @map("file_size")
  mimeType   String?  @map("mime_type") @db.VarChar(100)
  userId     Int?     @map("user_id")
  jobId      String?  @map("job_id") @db.Char(36)
  tags       Json?
  metadata   Json?
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  lastAccess DateTime @default(now()) @map("last_access")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  job  Job?  @relation(fields: [jobId], references: [id], onDelete: SetNull)

  @@index([bucket, userId])
  @@index([uploadedAt])
  @@index([jobId])
  @@map("minio_files")
}
